<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Food Nutrition Analyzer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        main {
            padding: 40px;
        }

        /* API Key Section */
        .api-key-section {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .api-key-section h3 {
            color: #856404;
            margin-bottom: 10px;
        }

        .api-key-input-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .api-key-input-group input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ffc107;
            border-radius: 8px;
            font-size: 1em;
        }

        .api-key-input-group button {
            padding: 12px 25px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .api-key-input-group button:hover {
            background: #5568d3;
        }

        .api-status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }

        .api-status.success {
            background: #d4edda;
            color: #155724;
        }

        .api-status.error {
            background: #f8d7da;
            color: #721c24;
        }

        /* Upload Section */
        .upload-section {
            margin-bottom: 40px;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 60px 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9ff;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: #f0f2ff;
            transform: translateY(-2px);
        }

        .upload-area.drag-over {
            border-color: #764ba2;
            background: #e8ebff;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 80px;
            color: #667eea;
            margin-bottom: 20px;
        }

        .upload-content h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
            color: #667eea;
        }

        .upload-content p {
            color: #666;
        }

        .preview-area {
            display: none;
        }

        .preview-area img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .remove-btn {
            display: block;
            margin: 15px auto 0;
            padding: 10px 20px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        .remove-btn:hover {
            background: #c82333;
        }

        .analyze-btn {
            width: 100%;
            padding: 18px;
            font-size: 1.2em;
            font-weight: bold;
            color: white;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .analyze-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .analyze-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Loading Section */
        .loading-section {
            display: none;
            text-align: center;
            padding: 60px 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Results Section */
        .results-section {
            display: none;
            background: #f8f9ff;
            border-radius: 15px;
            padding: 40px;
            margin-bottom: 40px;
        }

        .results-section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 2em;
        }

        .results-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            line-height: 1.8;
            white-space: pre-wrap;
        }

        .analyze-another-btn {
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
            font-weight: bold;
            color: #667eea;
            background: white;
            border: 2px solid #667eea;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .analyze-another-btn:hover {
            background: #667eea;
            color: white;
        }

        /* Error Section */
        .error-section {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .error-content {
            background: #fee;
            padding: 30px;
            border-radius: 15px;
            border: 2px solid #fcc;
        }

        .error-content h3 {
            color: #c33;
            margin-bottom: 15px;
        }

        .error-content p {
            color: #666;
            margin-bottom: 20px;
        }

        .try-again-btn {
            padding: 12px 30px;
            font-size: 1em;
            font-weight: bold;
            color: white;
            background: #c33;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .try-again-btn:hover {
            background: #a22;
        }

        /* History Section */
        .history-section {
            margin-top: 60px;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .history-header h2 {
            color: #667eea;
            font-size: 1.8em;
        }

        .clear-history-btn {
            padding: 10px 20px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
        }

        .clear-history-btn:hover {
            background: #f0f0f0;
        }

        .history-list {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 30px;
        }

        .no-history {
            text-align: center;
            color: #999;
            font-style: italic;
        }

        .history-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .history-item:hover {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .history-item-time {
            color: #999;
            font-size: 0.9em;
        }

        footer {
            background: #f8f9ff;
            text-align: center;
            padding: 20px;
            color: #666;
            border-top: 1px solid #eee;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            header h1 {
                font-size: 1.8em;
            }

            main {
                padding: 20px;
            }

            .upload-area {
                padding: 40px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üçé Smart Food Nutrition Analyzer</h1>
            <p>Upload a food image to get instant nutrition analysis powered by Claude AI</p>
        </header>

        <main>
            <!-- API Key Section -->
            <section class="api-key-section" id="apiKeySection">
                <h3>‚öôÔ∏è Setup Required</h3>
                <p>Enter your Claude API key to get started. Get one free at <a href="https://console.anthropic.com" target="_blank">console.anthropic.com</a></p>
                <div class="api-key-input-group">
                    <input type="password" id="apiKeyInput" placeholder="sk-ant-api03-...">
                    <button onclick="saveApiKey()">Save Key</button>
                </div>
                <div class="api-status" id="apiStatus"></div>
            </section>

            <!-- Upload Section -->
            <section class="upload-section" id="uploadSection" style="display: none;">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-content" id="uploadContent">
                        <div class="upload-icon">üì∏</div>
                        <h3>Drop your food image here</h3>
                        <p>or click to browse (PNG, JPG, GIF, WebP)</p>
                        <input type="file" id="fileInput" accept="image/*" hidden>
                    </div>
                    <div class="preview-area" id="previewArea">
                        <img id="previewImage" alt="Preview">
                        <button class="remove-btn" onclick="removeImage()">Remove Image</button>
                    </div>
                </div>
                <button class="analyze-btn" id="analyzeBtn" onclick="analyzeImage()" disabled>
                    üîç Analyze Nutrition
                </button>
            </section>

            <!-- Loading Section -->
            <section class="loading-section" id="loadingSection">
                <div class="spinner"></div>
                <p>Analyzing your food image with Claude AI...</p>
                <p style="color: #999; margin-top: 10px;">This may take 5-10 seconds</p>
            </section>

            <!-- Results Section -->
            <section class="results-section" id="resultsSection">
                <h2>üìä Nutrition Analysis Results</h2>
                <div class="results-content" id="resultsContent"></div>
                <button class="analyze-another-btn" onclick="analyzeAnother()">
                    Analyze Another Image
                </button>
            </section>

            <!-- Error Section -->
            <section class="error-section" id="errorSection">
                <div class="error-content">
                    <h3>‚ö†Ô∏è Oops! Something went wrong</h3>
                    <p id="errorMessage"></p>
                    <button class="try-again-btn" onclick="tryAgain()">Try Again</button>
                </div>
            </section>

            <!-- History Section -->
            <section class="history-section" id="historySection" style="display: none;">
                <div class="history-header">
                    <h2>üìö Recent Analyses</h2>
                    <button class="clear-history-btn" onclick="clearHistory()">Clear History</button>
                </div>
                <div class="history-list" id="historyList">
                    <p class="no-history">No analyses yet. Upload your first food image!</p>
                </div>
            </section>
        </main>

        <footer>
            <p>Powered by Claude AI (Anthropic) | Built for learning purposes</p>
            <p style="margin-top: 5px; font-size: 0.9em;">Your API key is stored locally in your browser</p>
        </footer>
    </div>

    <script>
        // Global state
        let apiKey = '';
        let selectedFile = null;
        let history = [];

        // Initialize on page load
        window.onload = function() {
            loadApiKey();
            loadHistory();
            setupEventListeners();
        };

        // Setup event listeners
        function setupEventListeners() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            // Click to upload
            uploadArea.addEventListener('click', () => {
                if (document.getElementById('uploadContent').style.display !== 'none') {
                    fileInput.click();
                }
            });

            // File selection
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) handleFile(file);
            });

            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('drag-over');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('drag-over');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('image/')) {
                    handleFile(file);
                }
            });
        }

        // Save API Key
        function saveApiKey() {
            const input = document.getElementById('apiKeyInput');
            const key = input.value.trim();
            
            if (!key) {
                showApiStatus('Please enter an API key', false);
                return;
            }

            if (!key.startsWith('sk-ant-')) {
                showApiStatus('Invalid API key format. Should start with sk-ant-', false);
                return;
            }

            apiKey = key;
            localStorage.setItem('claude_api_key', key);
            
            showApiStatus('API key saved successfully!', true);
            
            setTimeout(() => {
                document.getElementById('apiKeySection').style.display = 'none';
                document.getElementById('uploadSection').style.display = 'block';
                document.getElementById('historySection').style.display = 'block';
            }, 1000);
        }

        // Load API Key from localStorage
        function loadApiKey() {
            const stored = localStorage.getItem('claude_api_key');
            if (stored) {
                apiKey = stored;
                document.getElementById('apiKeySection').style.display = 'none';
                document.getElementById('uploadSection').style.display = 'block';
                document.getElementById('historySection').style.display = 'block';
            }
        }

        // Show API status message
        function showApiStatus(message, success) {
            const status = document.getElementById('apiStatus');
            status.textContent = message;
            status.className = 'api-status ' + (success ? 'success' : 'error');
            status.style.display = 'block';
        }

        // Handle file selection
        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                showError('Please upload an image file (PNG, JPG, GIF, WebP)');
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                showError('Image is too large. Maximum size is 5MB');
                return;
            }

            selectedFile = file;

            // Show preview
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('previewImage').src = e.target.result;
                document.getElementById('uploadContent').style.display = 'none';
                document.getElementById('previewArea').style.display = 'block';
                document.getElementById('analyzeBtn').disabled = false;
            };
            reader.readAsDataURL(file);
        }

        // Remove image
        function removeImage() {
            selectedFile = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('uploadContent').style.display = 'block';
            document.getElementById('previewArea').style.display = 'none';
            document.getElementById('analyzeBtn').disabled = true;
        }

        // Convert image to base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Get media type from filename
        function getMediaType(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const types = {
                'jpg': 'image/jpeg',
                'jpeg': 'image/jpeg',
                'png': 'image/png',
                'gif': 'image/gif',
                'webp': 'image/webp'
            };
            return types[ext] || 'image/jpeg';
        }

        // Analyze image with Claude AI
        async function analyzeImage() {
            if (!selectedFile) return;

            // Hide sections
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('errorSection').style.display = 'none';
            document.getElementById('loadingSection').style.display = 'block';

            try {
                // Convert image to base64
                const base64Image = await fileToBase64(selectedFile);
                const mediaType = getMediaType(selectedFile.name);

                // Create the prompt
                const prompt = `Analyze this food image and provide a detailed nutrition breakdown.

Please provide:
1. **Food Identification**: What food items do you see?
2. **Estimated Portion Size**: Approximate serving size
3. **Calorie Estimate**: Total calories (be realistic)
4. **Macronutrients**:
   - Protein (grams)
   - Carbohydrates (grams)
   - Fat (grams)
   - Fiber (grams)
5. **Key Micronutrients**: Important vitamins and minerals present
6. **Health Assessment**: Is this meal healthy? Rate it 1-10
7. **Dietary Considerations**: 
   - Suitable for: (vegetarian, vegan, keto, etc.)
   - Allergen warnings: (nuts, dairy, gluten, etc.)
8. **Improvement Suggestions**: 3 specific ways to make this meal healthier

Format your response in clear sections with emojis. Be specific with numbers but acknowledge these are estimates.`;

                // Call Claude API
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1500,
                        messages: [{
                            role: 'user',
                            content: [
                                {
                                    type: 'image',
                                    source: {
                                        type: 'base64',
                                        media_type: mediaType,
                                        data: base64Image
                                    }
                                },
                                {
                                    type: 'text',
                                    text: prompt
                                }
                            ]
                        }]
                    })
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error.message || 'API request failed');
                }

                // Display results
                const analysis = data.content[0].text;
                displayResults(analysis);
                saveToHistory(analysis);

            } catch (error) {
                console.error('Error:', error);
                showError(error.message || 'Failed to analyze image. Please check your API key and try again.');
            }
        }

        // Display results
        function displayResults(analysis) {
            document.getElementById('loadingSection').style.display = 'none';
            document.getElementById('resultsContent').textContent = analysis;
            document.getElementById('resultsSection').style.display = 'block';
        }

        // Show error
        function showError(message) {
            document.getElementById('loadingSection').style.display = 'none';
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorSection').style.display = 'block';
        }

        // Try again
        function tryAgain() {
            document.getElementById('errorSection').style.display = 'none';
            document.getElementById('uploadSection').style.display = 'block';
            removeImage();
        }

        // Analyze another
        function analyzeAnother() {
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('uploadSection').style.display = 'block';
            removeImage();
        }

        // Save to history
        function saveToHistory(analysis) {
            const entry = {
                timestamp: new Date().toISOString(),
                analysis: analysis,
                preview: analysis.substring(0, 100)
            };

            history.unshift(entry);
            if (history.length > 20) history = history.slice(0, 20);
            
            localStorage.setItem('nutrition_history', JSON.stringify(history));
            displayHistory();
        }

        // Load history
        function loadHistory() {
            const stored = localStorage.getItem('nutrition_history');
            if (stored) {
                history = JSON.parse(stored);
                displayHistory();
            }
        }

        // Display history
        function displayHistory() {
            const container = document.getElementById('historyList');
            
            if (history.length === 0) {
                container.innerHTML = '<p class="no-history">No analyses yet. Upload your first food image!</p>';
                return;
            }

            container.innerHTML = history.map((item, index) => {
                const date = new Date(item.timestamp);
                const timeStr = date.toLocaleString();
                
                return `
                    <div class="history-item" onclick="viewHistory(${index})">
                        <div class="history-item-header">
                            <strong>Analysis #${history.length - index}</strong>
                            <span class="history-item-time">${timeStr}</span>
                        </div>
                        <div>${item.preview}...</div>
                    </div>
                `;
            }).join('');
        }

        // View history item
        function viewHistory(index) {
            const item = history[index];
            displayResults(item.analysis);
            document.getElementById('uploadSection').style.display = 'none';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Clear history
        function clearHistory() {
            if (!confirm('Are you sure you want to clear all history?')) return;
            
            history = [];
            localStorage.removeItem('nutrition_history');
            displayHistory();
        }
    </script>
</body>
</html>